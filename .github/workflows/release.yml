name: Night Core Console â€” Build

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  WORKER_REPO: xnfinite/nightcore-worker
  WORKER_RELEASE_TAG: v1.1.1 
  WORKER_ASSET_WINDOWS: nightcore-worker-windows.exe
  WORKER_ASSET_LINUX: nightcore-worker-linux


jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: windows
          - os: ubuntu-latest
            target: linux

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend dependencies
        run: npm install

      - name: Build frontend
        run: npm run build

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            pkg-config

      # -----------------------------
      # Download private Worker binary
      # -----------------------------

      - name: Download Worker (Windows)
        if: matrix.target == 'windows'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.WORKER_REPO_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker" | Out-Null

          $api = "https://api.github.com/repos/${env:WORKER_REPO}/releases/tags/${env:WORKER_RELEASE_TAG}"
          $headers = @{
            Authorization = "Bearer $env:GH_TOKEN"
            "User-Agent"  = "nightcore-ci"
            Accept        = "application/vnd.github+json"
          }

          $release = Invoke-RestMethod -Headers $headers -Uri $api
          $asset = $release.assets | Where-Object { $_.name -eq $env:WORKER_ASSET_WINDOWS } | Select-Object -First 1

          if (-not $asset) {
            throw "Worker asset not found: $env:WORKER_ASSET_WINDOWS on tag $env:WORKER_RELEASE_TAG"
          }

          $outPath = "src-tauri/resources/worker/nightcore.exe"
          Invoke-WebRequest -Headers @{ Authorization = "Bearer $env:GH_TOKEN"; "User-Agent"="nightcore-ci" } `
            -Uri $asset.browser_download_url -OutFile $outPath

          if (-not (Test-Path $outPath)) {
            throw "Worker download failed: $outPath does not exist"
          }

          Write-Host "Worker downloaded -> $outPath"

      - name: Download Worker (Linux)
        if: matrix.target == 'linux'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.WORKER_REPO_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p src-tauri/resources/worker

          api="https://api.github.com/repos/${WORKER_REPO}/releases/tags/${WORKER_RELEASE_TAG}"
          json="$(curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "User-Agent: nightcore-ci" \
            -H "Accept: application/vnd.github+json" \
            "${api}")"

          url="$(echo "${json}" | python3 -c "import sys,json; r=json.load(sys.stdin); name='${WORKER_ASSET_LINUX}'; 
for a in r.get('assets',[]): 
  if a.get('name')==name: 
    print(a.get('browser_download_url','')); 
    break")"

          if [ -z "${url}" ]; then
            echo "Worker asset not found: ${WORKER_ASSET_LINUX} on tag ${WORKER_RELEASE_TAG}"
            exit 1
          fi

          out="src-tauri/resources/worker/nightcore"
          curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "User-Agent: nightcore-ci" \
            -L "${url}" -o "${out}"

          chmod +x "${out}"

          test -f "${out}" || (echo "Worker download failed: ${out} missing" && exit 1)

          echo "Worker downloaded -> ${out}"

      - name: Build Tauri app
        run: npx tauri build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightcore-${{ matrix.target }}
          path: src-tauri/target/release/bundle
