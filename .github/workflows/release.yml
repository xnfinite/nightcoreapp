name: Night Core Console â€” Build

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  WORKER_REPO: xnfinite/nightcore-worker
  WORKER_RELEASE_TAG: v1.1.1
  WORKER_ASSET_WINDOWS: nightcore-worker-windows.exe
  WORKER_ASSET_LINUX: nightcore-worker-linux

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: windows
          - os: ubuntu-latest
            target: linux

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install

      - run: npm run build

      - uses: dtolnay/rust-toolchain@stable

      - if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            pkg-config

      - if: matrix.target == 'windows'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.WORKER_REPO_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker" | Out-Null
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker\modules" | Out-Null

          $api = "https://api.github.com/repos/${env:WORKER_REPO}/releases/tags/${env:WORKER_RELEASE_TAG}"

          $release = Invoke-RestMethod `
            -Headers @{ Authorization = "Bearer $env:GH_TOKEN"; "User-Agent" = "nightcore-ci" } `
            -Uri $api

          $asset = $release.assets |
            Where-Object { $_.name -eq $env:WORKER_ASSET_WINDOWS } |
            Select-Object -First 1

          if (-not $asset) {
            throw "Worker asset not found"
          }

          $out = "src-tauri/resources/worker/nightcore.exe"

          Invoke-WebRequest `
            -Headers @{
              Authorization = "Bearer $env:GH_TOKEN"
              Accept        = "application/octet-stream"
              "User-Agent"  = "nightcore-ci"
            } `
            -Uri $asset.url `
            -OutFile $out

          if (-not (Test-Path $out)) {
            throw "Worker download failed"
          }

      - if: matrix.target == 'linux'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.WORKER_REPO_TOKEN }}
        run: |
          set -e

          mkdir -p src-tauri/resources/worker
          mkdir -p src-tauri/resources/worker/modules

          api="https://api.github.com/repos/${WORKER_REPO}/releases/tags/${WORKER_RELEASE_TAG}"

          json="$(curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "User-Agent: nightcore-ci" \
            "${api}")"

          asset_url="$(echo "${json}" | jq -r \
            --arg name "${WORKER_ASSET_LINUX}" \
            '.assets[] | select(.name == $name) | .url')"

          if [ -z "${asset_url}" ] || [ "${asset_url}" = "null" ]; then
            echo "Worker asset not found"
            exit 1
          fi

          out="src-tauri/resources/worker/nightcore"

          curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/octet-stream" \
            -L "${asset_url}" -o "${out}"

          chmod +x "${out}"

          touch src-tauri/resources/worker/nightcore.exe

          if [ ! -f "${out}" ]; then
            echo "Worker download failed"
            exit 1
          fi

      - run: npx tauri build

      - uses: actions/upload-artifact@v4
        with:
          name: nightcore-${{ matrix.target }}
          path: src-tauri/target/release/bundle
