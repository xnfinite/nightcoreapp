name: Night Core Console — Build

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  WORKER_REPO: xnfinite/nightcore-worker
  WORKER_RELEASE_TAG: v1.1.4
  WORKER_ASSET_WINDOWS: nightcore.exe
  WORKER_ASSET_LINUX: nightcore-worker-linux

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: windows
          - os: ubuntu-latest
            target: linux

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # -----------------------------
      # Node / frontend
      # -----------------------------
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install
      - run: npm run build

      # -----------------------------
      # Rust / Tauri
      # -----------------------------
      - uses: dtolnay/rust-toolchain@stable

      # -----------------------------
      # Linux system deps
      # -----------------------------
      - if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            pkg-config \
            jq

      # -----------------------------
      # Worker download — WINDOWS
      # -----------------------------
      - if: matrix.target == 'windows'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.WORKER_REPO_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker"
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/modules"
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/logs"
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/quarantine"
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/proof"
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/guardian"
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/state"
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/keys/maintainers"

          # Build-time placeholder key (NOT a real signing key)
          New-Item -ItemType File -Force -Path "src-tauri/resources/worker/keys/maintainers/admin1.key" | Out-Null

          $api = "https://api.github.com/repos/$env:WORKER_REPO/releases/tags/$env:WORKER_RELEASE_TAG"

          $release = Invoke-RestMethod `
            -Headers @{ Authorization = "Bearer $env:GH_TOKEN"; "User-Agent" = "nightcore-ci" } `
            -Uri $api

          $asset = $null
          foreach ($a in $release.assets) {
            if ($a.name -eq $env:WORKER_ASSET_WINDOWS) {
              $asset = $a
            }
          }

          if ($null -eq $asset) {
            throw "Worker Windows asset not found"
          }

          Invoke-WebRequest `
            -Uri $asset.browser_download_url `
            -Headers @{ "User-Agent" = "nightcore-ci" } `
            -OutFile "src-tauri/resources/worker/nightcore.exe"

          New-Item -ItemType File -Force -Path "src-tauri/resources/worker/nightcore" | Out-Null

      # -----------------------------
      # Worker download — LINUX
      # -----------------------------
      - if: matrix.target == 'linux'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.WORKER_REPO_TOKEN }}
        run: |
          set -e

          mkdir -p src-tauri/resources/worker/modules
          mkdir -p src-tauri/resources/worker/logs
          mkdir -p src-tauri/resources/worker/quarantine
          mkdir -p src-tauri/resources/worker/proof
          mkdir -p src-tauri/resources/worker/guardian
          mkdir -p src-tauri/resources/worker/state
          mkdir -p src-tauri/resources/worker/keys/maintainers

          # Build-time placeholder key (NOT a real signing key)
          touch src-tauri/resources/worker/keys/maintainers/admin1.key

          api="https://api.github.com/repos/${WORKER_REPO}/releases/tags/${WORKER_RELEASE_TAG}"

          json="$(curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "User-Agent: nightcore-ci" \
            "${api}")"

          asset_url="$(echo "${json}" | jq -r \
            --arg name "${WORKER_ASSET_LINUX}" \
            '.assets[] | select(.name == $name) | .browser_download_url')"

          if [ -z "${asset_url}" ] || [ "${asset_url}" = "null" ]; then
            echo "Worker Linux asset not found"
            exit 1
          fi

          curl -fsSL "${asset_url}" -o src-tauri/resources/worker/nightcore
          chmod +x src-tauri/resources/worker/nightcore

          touch src-tauri/resources/worker/nightcore.exe

      # -----------------------------
      # FINAL GUARANTEE (CRITICAL)
      # -----------------------------
      - name: Ensure worker runtime directories exist
        shell: bash
        run: |
          cd src-tauri
          mkdir -p resources/worker/modules
          mkdir -p resources/worker/logs
          mkdir -p resources/worker/quarantine
          mkdir -p resources/worker/proof
          mkdir -p resources/worker/guardian
          mkdir -p resources/worker/state
          mkdir -p resources/worker/keys/maintainers
          touch resources/worker/keys/maintainers/admin1.key

      # -----------------------------
      # CLEAN TAURI CACHE (FIXES PERMISSION STALENESS)
      # -----------------------------
      - name: Clean Tauri build cache
        shell: bash
        run: |
          rm -rf src-tauri/target

      # -----------------------------
      # Build Tauri app
      # -----------------------------
      - run: npx tauri build

      # -----------------------------
      # Upload artifacts
      # -----------------------------
      - uses: actions/upload-artifact@v4
        with:
          name: nightcore-${{ matrix.target }}
          path: src-tauri/target/release
