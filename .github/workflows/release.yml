name: Night Core Console â€” Build

on:
  # Manual trigger (use this while iterating)
  workflow_dispatch:

  # Normal CI on main (VERY IMPORTANT)
  push:
    branches:
      - main
    tags:
      - "v*"

env:
  WORKER_REPO: xnfinite/nightcore-worker
  WORKER_RELEASE_TAG: v1.1.6  # already exists â€” OK
  WORKER_ASSET_WINDOWS: nightcore.exe
  WORKER_ASSET_LINUX: nightcore-worker-linux

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: windows
          - os: ubuntu-latest
            target: linux

    runs-on: ${{ matrix.os }}

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - uses: actions/checkout@v4

      # -------------------------------------------------
      # ðŸ”‘ BUILD-TIME RESOURCE (TAURI v2)
      # MUST exist BEFORE tauri build scripts run
      # OS-NATIVE creation to avoid shell issues
      # -------------------------------------------------
      - name: Pre-create worker key (Linux)
        if: matrix.target == 'linux'
        shell: bash
        run: |
          mkdir -p src-tauri/resources/worker/keys/maintainers
          touch src-tauri/resources/worker/keys/maintainers/admin1.key

      - name: Pre-create worker key (Windows)
        if: matrix.target == 'windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force `
            -Path "src-tauri/resources/worker/keys/maintainers" | Out-Null
          New-Item -ItemType File -Force `
            -Path "src-tauri/resources/worker/keys/maintainers/admin1.key" | Out-Null

      # -------------------------------------------------
      # Node / Frontend
      # -------------------------------------------------
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install
      - run: npm run build

      # -------------------------------------------------
      # Rust / Tauri
      # -------------------------------------------------
      - uses: dtolnay/rust-toolchain@stable

      # -------------------------------------------------
      # Linux system deps
      # -------------------------------------------------
      - if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            pkg-config \
            jq

      # -------------------------------------------------
      # Debug: confirm worker tag is visible
      # -------------------------------------------------
      - name: Debug worker release tag
        shell: bash
        run: |
          echo "Using worker repo: $WORKER_REPO"
          echo "Using worker tag:  $WORKER_RELEASE_TAG"

      # -------------------------------------------------
      # Worker download â€” WINDOWS
      # -------------------------------------------------
      - if: matrix.target == 'windows'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.WORKER_REPO_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker" | Out-Null
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/modules" | Out-Null
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/logs" | Out-Null
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/quarantine" | Out-Null
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/proof" | Out-Null
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/guardian" | Out-Null
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/worker/state" | Out-Null

          $api = "https://api.github.com/repos/$env:WORKER_REPO/releases/tags/$env:WORKER_RELEASE_TAG"
          $release = Invoke-RestMethod `
            -Headers @{ Authorization = "Bearer $env:GH_TOKEN"; "User-Agent" = "nightcore-ci" } `
            -Uri $api

          $asset = $release.assets |
            Where-Object { $_.name -eq $env:WORKER_ASSET_WINDOWS } |
            Select-Object -First 1

          if (-not $asset) {
            throw "Worker Windows asset not found"
          }

          Invoke-WebRequest `
            -Headers @{
              Authorization = "Bearer $env:GH_TOKEN"
              Accept        = "application/octet-stream"
              "User-Agent"  = "nightcore-ci"
            } `
            -Uri $asset.url `
            -OutFile "src-tauri/resources/worker/nightcore.exe"

          New-Item -ItemType File -Force -Path "src-tauri/resources/worker/nightcore" | Out-Null

      # -------------------------------------------------
      # Worker download â€” LINUX
      # -------------------------------------------------
      - if: matrix.target == 'linux'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.WORKER_REPO_TOKEN }}
        run: |
          set -e

          mkdir -p src-tauri/resources/worker

          api="https://api.github.com/repos/${WORKER_REPO}/releases/tags/${WORKER_RELEASE_TAG}"
          json="$(curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "User-Agent: nightcore-ci" \
            "${api}")"

          asset_url="$(echo "${json}" | jq -r \
            --arg name "${WORKER_ASSET_LINUX}" \
            '.assets[] | select(.name == $name) | .url')"

          if [ -z "${asset_url}" ] || [ "${asset_url}" = "null" ]; then
            echo "Worker Linux asset not found"
            exit 1
          fi

          curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/octet-stream" \
            -L "${asset_url}" \
            -o src-tauri/resources/worker/nightcore

          chmod +x src-tauri/resources/worker/nightcore
          touch src-tauri/resources/worker/nightcore.exe

      # -------------------------------------------------
      # Final directory safety (never hurts)
      # -------------------------------------------------
      - name: Final worker directory guarantee
        shell: bash
        run: |
          mkdir -p src-tauri/resources/worker/{modules,logs,quarantine,proof,guardian,state,keys/maintainers}
          touch src-tauri/resources/worker/keys/maintainers/admin1.key

      # -------------------------------------------------
      # Build Tauri App
      # -------------------------------------------------
      - run: npx tauri build

      # -------------------------------------------------
      # Upload Artifacts
      # -------------------------------------------------
      - uses: actions/upload-artifact@v4
        with:
          name: nightcore-${{ matrix.target }}
          path: src-tauri/target/release
